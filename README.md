# Backend-приложение – собственной системы аутентификации и авторизации, в котором реализована кастомная система разграничения прав доступа
### Стэк приложения:
### - DRF
### - PostgreSQL
На стороне backend реализована аутентификация/авторизация с помощью JWT токена. Для его выпуска используется библиотека PyJWT и cryptography, а также 2 ключа 

Приватный - для шифрования информации и формирования токенов авторизации

Публичный - для валидации токенов от пользователя с помощью дешифровки токенов


Генерация ключей выполнена с помощью криптографического инструмента **OpenSSl**. Команды для генерации:

private.pem - openssl genrsa -out private.pem 2048

public.pem - openssl rsa -in private.pem -outform PEM -pubout -out public.pem

В базе данных сформировано 4 сущности, из которых одна модель пользователя, три оставшихся для формирования системы доступа.

**CustomUsers** - модель пользователя

|id|name|surname|email|password|is_admin|is_active|
|-|-|-|-|-|-|-|
|Уникальный идентификатор|Имя|Фамилья|Почта|Пароль|Статус admin|Статус активный|

**AccessTypes** - модель типов доступа

|name|
|-|
|Наименование типа доступа|

**UserAccess** - модель разграничения пользователей с типом доступа, который закреплён за ними

|id|user_id|access_id|
|-|-|-|
|Уникальный идентификатор|ID пользователя|ID доступа|

**CustomPermissions** - модель описания прав доступа

|id|get|post|table_name|description|all_samples|access_id|
|-|-|-|-|-|-|-|
|Уникальный идентификатор|Метод GET|Метод POST|Наименование таблицы|Описание|Все экземпляры модели|ID доступа|
|Уникальный идентификатор|Разрешает/запрещает получать инфу|Разрешает/запрещает изменять инфу|Наименование таблицы из БД|Описание прав доступа|Получение/изменение всех моделей или одной|ID доступа|

Регистрация пользователя происходит посредством введения данных в форму с последующей валидацией полученных данных. В случае положительной проверки данных выполняется модификация пароля, используя библиотеку 
bcrypt, для получения хэша. Для дальнейшего доступа к ЛК и прочим страницам приложения, где необходима авторизация, пользователь должен войти в систему, указав почту и пароль. После успешной валидации система 
генерирует два токена - Access-Token и Refresh-Token. Оба токена устанавливаются пользователю в cookie. Далее система автоматически распознаёт пользователя если в cookie указан валидный Access-Token, а также если 
Access-Token перестал действовать система сгенерирует новый токен на основе Refresh-Token. Данный алгоритм продолжает действовать пока Refresh-Token не сгорел или пользователь не вышел из системы самостоятельно, 
в данном случае пользователю необходимо снова ввести почту и пароль для генерации токенов.забирает 

## Функционал приложения

### Взаимодействие с пользователем

Приложение позволяет пользователям регистрироваться, входить в систему, выходить из учетной записи, обновлять свои данные и удалять аккаунт.
- **Регистрация**: Ввод имени, фамилии, email, пароля, повтор пароля;
  
- **Обновление информации**: Пользователь может редактировать свойпрофиль;

- **Удаление пользователя**: Удаление аккаунта (мягкое) — пользователь инициирует удаление, происходит выход из системы. Пользователь больше не может залогиниться, но при этом в базе учетная запись
остается со статусом is_active=False.

- **Вход в систему**: пользователь входить в систему по email и паролю;

- **Выход из системы**: пользователь выходит из системы.

### Система разграничения прав доступа

В первую очередь система с помощью дополнительного middleware GetUserMiddleware определяет наличие токенов у пользователя. В случае наличия таковых GetUserMiddleware добавляет значения токенов к переменной request.
Далее для проверки валидности токенов реализован декоратор checker_auth. Задача данного дератора - проверить были ли установлены корректные токены пользователю, по которым выполнится определение пользователя. 
В случае неуспешной проверки система не сможет определить пользователя и в следовательно не допустит пользователя к переходу к выбранной странице и просмотру её контента, выдав страницу с ответом 401.

После определения пользователя приложение использует систему доступа к контенту описанную в БД. Для каждого пользователя, при регистрации, формируется запись в таблице UserAccess куда добавляется ID пользователя и
ID доступа. Изначально допускается два типа доступа:

- base_user (базовый пользователь)
- admin (пользователь с повышенными правами доступа)

Базовый тип доступа устанавливается всем новым пользователям (base_user). В таблице CustomPermissions указывается к каким данным и какой метод допускается для каждого типа доступа. Так как изначально в системе есть
таблицы с информацией о пользователях и описанием прав доступа, то в CustomPermissions сформированы 4 записи:

|id|get|post|table_name|description|all_samples|access_id|
|-|-|-|-|-|-|-|
|1|True|True|custom_users|Может просматривать и изменять только свой экземпляр CustomUsers|False|base_user|
|2|True|True|custom_users|Может просматривать и изменять любой экземпляр CustomUsers|True|admin|
|3|True|True|custom_permission|Может просматривать и вносить изменения во все экземпляры CustomPermissions|True|admin|
|4|False|False|custom_permission|Нет доступа на просмотр и внесения информации в экземпляры CustomPermissions|False|base_user|

При выполнении запроса пользователем на получение контента с информацией о пользователях, системой будет выполнен запрос в базу данных на определение прав доступа пользователя. Используя данные права система
может определить разрешен/запрещён пользователю просмотр страницы (метод GET). Если доступ к просмотру запрещён (GET = FALSE) тогда система не допустит пользователя к данному контенту вернув страницу с ответом 403.
В случае наличия прав на просмотр контента (GET = TRUE) система пропустит пользователя и в ответе вернёт интересующую страницу. Для выполнения запросов с методом POST система работает по идентичному алгоритму.

Для реализации просмотра прав доступа и определения какой ответ должен получить пользователь в приложении разработан блок dao (Data Access Object). Данный блок позволяет отдельно реализовать запросы в БД, а также 
отдельно реализовать все необходимые методы для каждой таблицы, наследуясь от базового класса AbstractDAO.

Приложение покрыто unit тестами в блоке tests.
----------------

### Запуск приложения
Для запуска приложения первоначально нужно создать файл .env в корне проекта, в нём указать следующие данные:

secret_key=ключ к приложению

DATABASE_NAME=наименование базы

DATABASE_USER=имя пользователя

DATABASE_PASSWORD=пароль

DATABASE_HOST=хост

DATABASE_PORT=порт

Установить зависимости из requirements.txt

Также в модуле **certs** необходимо разместить два файла с приватным и публичном ключами шифрования private.pem и public.pem (для генерации ключей можно применить команды, указанные выше).

Перед запуском приложения выполнить миграции, а для заполнения бд тестовыми данными в приложении реализован блок managements/commands, в котором находится файл, который заполнит бд тестовыми данными. 
Для его запуска используйте команду python manage.py migrate_data.

**Пример приложения**

Стартовая страница
<img width="1864" height="399" alt="image" src="https://github.com/user-attachments/assets/cdebf85d-4e05-47dd-aead-bc8388f949ae" />

Страница регистрации
<img width="1463" height="445" alt="image" src="https://github.com/user-attachments/assets/1397f506-546a-429b-9937-fdb728a49dae" />

Попытка зарегистрироваться без заполнения данных
<img width="1331" height="373" alt="image" src="https://github.com/user-attachments/assets/201f949b-a3ca-403f-8583-004f8606e63e" />

Страница входа в систему
<img width="1156" height="365" alt="image" src="https://github.com/user-attachments/assets/1078e574-0c64-489e-8c86-02a6ed25e014" />

Страница ЛК
<img width="1157" height="486" alt="image" src="https://github.com/user-attachments/assets/713e95b0-a139-4075-ac0d-564f06f255a0" />

Попытка посетить страницу без определенного доступа
<img width="1161" height="386" alt="image" src="https://github.com/user-attachments/assets/fc01e163-0a79-42e8-9aa7-2c4f5be20949" />
<img width="795" height="91" alt="image" src="https://github.com/user-attachments/assets/c2e5c0e2-899e-412d-b03c-85af723fd927" />

Страница изменения данных пользователя
<img width="1180" height="397" alt="image" src="https://github.com/user-attachments/assets/8c05da0e-b9ea-41d0-a9af-c609779c0f40" />

Попытка указать уже существующую почту при изменении своих данных
<img width="1185" height="388" alt="image" src="https://github.com/user-attachments/assets/9535e298-3e82-4d60-b348-68d130590e82" />

Попытка залогиниться после удаления
<img width="1194" height="351" alt="image" src="https://github.com/user-attachments/assets/4ac225d1-e617-401e-a8f3-dedbc916ba02" />

Страница с правами доступа для пользователя с правами admin
<img width="1155" height="854" alt="image" src="https://github.com/user-attachments/assets/df7bcd86-d3de-4201-81f3-3d34f682c47e" />

Страница изменения прав доступа
<img width="1349" height="400" alt="image" src="https://github.com/user-attachments/assets/c53d22ec-68bd-421a-8a9f-bbd42871674c" />





